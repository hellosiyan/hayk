<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>Caribou Preview</title>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" language="javascript" charset="utf-8"></script>
	<script type="text/javascript" language="javascript" charset="utf-8">
		jQuery(function($){
			var ws;
			var logs = $('.results ul');
			
			$('#form-connection').submit(function(){
				var th = $(this);
				ws = new WebSocket(th.find('input[name=url]').val());
				init_ws(ws);
				return false;
			});
			
			$('#form-message').submit(function(){
				var th = $(this);
				ws_send(th.find('input[name=msg]').val());
				return false;
			});
			
			$('#form-channel-sub').submit(function(){
				var th = $(this);
				ws_subscribe(th.find('input[name=channel]').val());
				return false;
			});
			
			$('#form-channel-unsub').submit(function(){
				var th = $(this);
				ws_unsubscribe(th.find('input[name=channel]').val());
				return false;
			});
			
			$('a.close').click(function(){
				ws.close();
			});
			
			function init_ws(ws) {
				ws.onopen = function(e){
					console.log('onopen', e);
					ws_log('** Connected to ' + e.target.url);
				}
			
				ws.onerror = function(a, b){
					console.log('onerror', a, b);
					ws_log('** Error: ');
				}
			
				ws.onmessage = function(e){
					console.log('onmessage', e);
					ws_log(e.data);
				}
			
				ws.onclose = function(e){
					console.log( e );
					ws_log('** Closed');
				}
			}
			
			function  ws_send(string) {
				ws.send('DAT\ntest\n' + string);
			}
			
			function  ws_subscribe(channel) {
				ws.send('CTL\nSubscribe: ' + channel + '\n');
			}
			
			function  ws_unsubscribe(channel) {
				ws.send('CTL\nUnsubscribe: ' + channel + '\n');
			}
			
			function ws_log(string) {
				var date = new Date();
				logs.prepend($('<li><em>' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + '</em> ' + string + '</li>'));
			}
		});
	</script>
</head>
<body>
	<form id="form-connection" action="" method="get">
		<input type="text" name="url" value="ws://localhost:8080/test" />
		<input type="submit" value="Init connection" />
		<a href="#" class="close">Close</a>
	</form>
	<form id="form-channel-sub" action="" method="get">
		<input type="text" name="channel" value="test" />
		<input type="submit" value="subscribe" />
	</form>
	<form id="form-channel-unsub" action="" method="get">
		<input type="text" name="channel" value="test" />
		<input type="submit" value="unsubscribe" />
	</form>
	<form id="form-message" action="" method="get">
		<input type="text" name="msg" value="Hello!" />
	
		<p><input type="submit" value="Send" /></p>
	</form>
	<div class="results">
		<ul>
			
		</ul>
	</div>
</body>
</html>
